<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP and Location Finder</title>
    <script>
        // Function to send location and IP data to Google Apps Script
        async function sendLocationData(ip, latitude, longitude) {
            const timestamp = new Date().toISOString(); // Get the current timestamp
            const data = {
                ip: ip,
                location: {
                    latitude: latitude,
                    longitude: longitude,
                },
                timestamp: timestamp,
            };

            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbw5TBrbXNF5W7wy8XoYV0EFavWEyng2bI_YYR_fNNWnNxfyfktfS1q2LnHarLmtTLU-/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    console.log('Data saved successfully!');
                    alert('Location and IP sent successfully!');
                } else {
                    console.error('Error saving data:', await response.text());
                    alert('Failed to save data.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Check the console for details.');
            }
        }

        // Function to get the user's IP-based location
        async function getLocationByIP() {
            try {
                // Fetch the IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const ip = ipData.ip;

                // Use IP Geolocation API to get location based on IP
                const geoResponse = await fetch(`https://api.ipstack.com/${ip}?access_key=0c2997f8aea05cd07d8bd174c81d5f13`);
                const geoData = await geoResponse.json();

                const latitude = geoData.latitude;
                const longitude = geoData.longitude;

                // Send the data to Google Apps Script
                sendLocationData(ip, latitude, longitude);
            } catch (error) {
                console.error('Error fetching location by IP:', error);
                alert('Failed to fetch IP or geolocation.');
            }
        }

        // Function to get the user's geolocation using the Geolocation API (if allowed)
        async function getLocation() {
            try {
                // Try to get the location using the Geolocation API
                const position = await new Promise((resolve, reject) => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    } else {
                        reject("Geolocation not supported");
                    }
                });

                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                // Now send the location data to Google Apps Script
                sendLocationData(null, latitude, longitude);
            } catch (error) {
                console.error('Error getting geolocation:', error);
                alert('Geolocation access denied or failed. Falling back to IP location.');

                // If geolocation fails, fall back to IP geolocation
                getLocationByIP();
            }
        }
    </script>
</head>
<body>
    <h1>IP and Location Finder</h1>
    <p>Click the button below to send your IP address and location:</p>
    <button id="sendLocation">Send Location</button>

    <script>
        // Attach the event listener to the button
        document.getElementById('sendLocation').addEventListener('click', getLocation);
    </script>
</body>
</html>
